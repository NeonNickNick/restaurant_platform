{% extends "restaurant/base.html" %}

{% block restaurant_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>顾客管理</h2>
    <div>
        <span class="badge bg-secondary">{{ customers.total }} 位顾客</span>
    </div>
</div>

<!-- 调试信息 -->
<div class="alert alert-info">
    <h5>调试信息</h5>
    <p>顾客总数: {{ customers.total }}</p>
    <p>当前页项目数: {{ customers.items|length }}</p>
    
    {% if customers.items %}
    <p>查询到的顾客:</p>
    <ul>
    {% for customer_data in customers.items %}
        {% if customer_data and customer_data[0] %}
        <li>{{ customer_data[0].username }} - 订单数: {{ customer_data[1] }} - 消费额: {{ customer_data[2] }}</li>
        {% endif %}
    {% endfor %}
    </ul>
    {% else %}
    <p>没有查询到顾客</p>
    {% endif %}
</div>

<!-- 排序筛选 -->
<div class="card mb-4">
    <div class="card-body">
        <h6>排序方式：</h6>
        <div class="btn-group" role="group">
            <a href="{{ url_for('restaurant.customers', restaurant_id=restaurant.id, sort_by='total_spent') }}" 
               class="btn btn-outline-secondary {% if sort_by == 'total_spent' %}active{% endif %}">
                按消费额排序
            </a>
            <a href="{{ url_for('restaurant.customers', restaurant_id=restaurant.id, sort_by='order_count') }}" 
               class="btn btn-outline-secondary {% if sort_by == 'order_count' %}active{% endif %}">
                按订单数排序
            </a>
        </div>
    </div>
</div>

<!-- 顾客列表 -->
<div class="card">
    <div class="card-body">
        {% if customers.items %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>顾客</th>
                        <th>消费总额</th>
                        <th>订单数</th>
                        <th>最后消费</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer_data in customers.items %}
                    {% if customer_data and customer_data[0] %}
                    {% set customer = customer_data[0] %}
                    {% set order_count = customer_data[1] if customer_data[1] is defined else 0 %}
                    {% set total_spent = customer_data[2] if customer_data[2] is defined else 0 %}
                    {% set last_order_date = customer_last_orders.get(customer.id) if customer_last_orders is defined else None %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='uploads/avatars/' + customer.avatar_path) }}" 
                                     alt="头像" class="rounded-circle me-2" width="40" height="40">
                                <div>
                                    <strong>{{ customer.username }}</strong>
                                    <div class="text-muted small">{{ customer.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong class="text-success">¥{{ "%.2f"|format(total_spent) }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ order_count }} 单</span>
                        </td>
                        <td>
                            {% if last_order_date %}
                            <small>{{ last_order_date.strftime('%Y-%m-%d') }}</small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <!-- 临时禁用详情链接，避免错误 -->
                            <button class="btn btn-sm btn-outline-info" disabled>
                                <i class="bi bi-eye"></i> 详情
                            </button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        {% if customers.pages > 1 %}
        <nav aria-label="顾客分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if customers.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('restaurant.customers', restaurant_id=restaurant.id, page=customers.prev_num, sort_by=sort_by) }}">
                        上一页
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">上一页</span>
                </li>
                {% endif %}
                
                {% for page_num in customers.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == customers.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('restaurant.customers', restaurant_id=restaurant.id, page=page_num, sort_by=sort_by) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if customers.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('restaurant.customers', restaurant_id=restaurant.id, page=customers.next_num, sort_by=sort_by) }}">
                        下一页
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">下一页</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people display-1 text-muted"></i>
            <h4 class="mt-3">暂无顾客</h4>
            <p class="text-muted">还没有任何顾客消费记录</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 消费统计 -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-primary">{{ customers.total }}</h2>
                <p class="text-muted mb-0">总顾客数</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                {% set total_orders = 0 %}
                {% for customer_data in customers.items %}
                    {% if customer_data and customer_data[1] is defined %}
                        {% set order_count = customer_data[1] %}
                        {% set total_orders = total_orders + order_count %}
                    {% endif %}
                {% endfor %}
                <h2 class="text-success">{{ total_orders }}</h2>
                <p class="text-muted mb-0">总订单数</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                {% set total_spent_sum = 0 %}
                {% for customer_data in customers.items %}
                    {% if customer_data and customer_data[2] is defined %}
                        {% set total_spent = customer_data[2] %}
                        {% set total_spent_sum = total_spent_sum + total_spent %}
                    {% endif %}
                {% endfor %}
                {% set avg_spent = total_spent_sum / customers.total if customers.total > 0 else 0 %}
                <h2 class="text-warning">¥{{ "%.2f"|format(avg_spent) }}</h2>
                <p class="text-muted mb-0">客单价</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}